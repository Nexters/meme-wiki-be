<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>밈 관리 - 밈위키 관리자</title>
    <link href="/webjars/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            font-weight: 600;
            padding: 1.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .btn-danger {
            border-radius: 8px;
            font-weight: 600;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
        }
        .meme-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            max-height: calc(1.4em * 2);
        }
        .badge {
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .emoji {
            font-size: 2rem;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                🎭 밈위키 관리자
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-white me-3" href="/admin/memes">📝 전체 밈 관리</a>
                <a class="nav-link text-white me-3" href="/admin/memes/review">🔍 검토 대기</a>
                <a class="nav-link text-white me-3" href="/admin/memes/stats">📊 인기 밈 통계</a>
                <span class="navbar-text me-3">
                    👋 관리자님, 안녕하세요!
                </span>
                <a class="btn btn-outline-light btn-sm" th:href="@{/admin/logout}">
                    🚪 로그아웃
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- 알림 메시지 -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- 통계 카드 -->
        <div class="stats-card">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="emoji">📊</div>
                    <h3 th:text="${totalCount}">0</h3>
                    <p class="mb-0">총 밈 개수</p>
                </div>
                <div class="col-md-4">
                    <div class="emoji">🆕</div>
                    <h3>관리</h3>
                    <p class="mb-0">밈 추가/삭제</p>
                </div>
                <div class="col-md-4">
                    <a href="/admin/memes/stats" class="text-decoration-none text-white">
                        <div class="emoji">📊</div>
                        <h3>인기 밈</h3>
                        <p class="mb-0">통계 조회</p>
                    </a>
                </div>
            </div>
        </div>

        <!-- 카테고리 가이드 -->
        <div class="row mb-4" th:if="${not #lists.isEmpty(categories)}">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">📂 현재 등록된 카테고리</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div th:each="category : ${categories}" class="col-md-3 mb-3">
                                <div class="p-3 bg-light rounded text-center">
                                    <img th:if="${category.imgUrl}" 
                                         th:src="${category.imgUrl}" 
                                         th:alt="${category.name}"
                                         class="mb-2"
                                         style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
                                    <h6 class="fw-bold text-primary" th:text="|ID: ${category.id}|">ID: 1</h6>
                                    <p class="mb-0 fw-bold" th:text="${category.name}">카테고리명</p>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mb-0">
                            <small>
                                <strong>💡 팁:</strong> 
                                위의 카테고리 ID를 참고해서 밈에 적절한 카테고리를 지정해주세요.
                                밈의 성격과 사용 맥락에 따라 적절한 카테고리를 선택하세요.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 새 밈 추가 폼 -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">🆕 새 밈 추가</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/admin/memes}" method="post" id="addMemeForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="title" class="form-label fw-bold">밈 제목 *</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="title" 
                                       name="title" 
                                       placeholder="예: 오히려 좋아"
                                       required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="origin" class="form-label fw-bold">출처/유래 *</label>
                                <textarea class="form-control" 
                                          id="origin" 
                                          name="origin" 
                                          rows="2"
                                          placeholder="예: 무한도전 박명수"
                                          required></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="usageContext" class="form-label fw-bold">사용 맥락 *</label>
                                <textarea class="form-control" 
                                          id="usageContext" 
                                          name="usageContext" 
                                          rows="3"
                                          placeholder="언제, 어떤 상황에서 사용하는지 자세히 설명"
                                          required></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="hashtags" class="form-label fw-bold">해시태그 *</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="hashtags" 
                                       name="hashtags" 
                                       placeholder="예: #허무 #망함 #폭망 #무한도전"
                                       required>
                            </div>
                            
                            <!-- 카테고리 선택 -->
                            <div class="mb-3" th:if="${not #lists.isEmpty(categories)}">
                                <label for="categoryIds" class="form-label fw-bold">카테고리 선택</label>
                                <div class="card border-light bg-light">
                                    <div class="card-body p-3">
                                        <div class="row">
                                            <div th:each="category : ${categories}" class="col-6 mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" 
                                                           type="checkbox" 
                                                           th:id="|category_${category.id}|"
                                                           name="categoryIds" 
                                                           th:value="${category.id}">
                                                    <label class="form-check-label d-flex align-items-center" 
                                                           th:for="|category_${category.id}|">
                                                        <img th:if="${category.imgUrl}" 
                                                             th:src="${category.imgUrl}" 
                                                             th:alt="${category.name}"
                                                             class="me-2"
                                                             style="width: 20px; height: 20px; object-fit: cover; border-radius: 50%;">
                                                        <small th:text="|${category.name} (ID: ${category.id})|">카테고리명 (ID: 1)</small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-text">
                                            <small>※ 해당하는 카테고리를 모두 선택해주세요 (복수 선택 가능)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 이미지 업로드/URL 선택 -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">이미지 *</label>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card border-light bg-light">
                                            <div class="card-body p-3">
                                                <!-- 파일 업로드 옵션 -->
                                                <div class="mb-3">
                                                    <label for="imageFile" class="form-label">📁 파일 업로드 (추천)</label>
                                                    <input type="file" 
                                                           class="form-control" 
                                                           id="imageFile" 
                                                           name="imageFile" 
                                                           accept="image/*"
                                                           onchange="toggleImageOptions(this)">
                                                    <div class="form-text">
                                                        <small>지원 형식: JPG, PNG, GIF, WebP (최대 10MB)</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="text-center mb-2">
                                                    <span class="badge bg-secondary">또는</span>
                                                </div>
                                                
                                                <!-- URL 입력 옵션 -->
                                                <div class="mb-0">
                                                    <label for="imgUrl" class="form-label">🔗 이미지 URL</label>
                                                    <input type="url" 
                                                           class="form-control" 
                                                           id="imgUrl" 
                                                           name="imgUrl" 
                                                           placeholder="https://example.com/image.jpg"
                                                           onchange="toggleImageOptions(this)">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="trendPeriod" class="form-label fw-bold">유행 시기</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="trendPeriod" 
                                       name="trendPeriod" 
                                       placeholder="예: 2020">
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <span class="loading spinner-border spinner-border-sm me-2"></span>
                                    ➕ 밈 추가하기
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 밈 리스트 -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">📝 밈 리스트</h5>
                            <span class="badge bg-light text-dark" id="memeCount" th:text="|총 ${totalCount}개|">총 0개</span>
                        </div>
                        
                        <!-- 검색 및 필터 옵션 -->
                        <div class="row g-2">
                            <div class="col-md-5">
                                <div class="input-group">
                                    <span class="input-group-text bg-white">🔍</span>
                                    <input type="text" 
                                           class="form-control" 
                                           id="searchInput" 
                                           placeholder="제목, 출처, 사용맥락, 해시태그로 검색...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="categoryFilter">
                                    <option value="">전체 카테고리</option>
                                    <option value="미분류">미분류</option>
                                    <option th:each="category : ${categories}" 
                                            th:value="${category.name}" 
                                            th:text="${category.name}">카테고리</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check d-flex align-items-center h-100 ps-3">
                                    <input class="form-check-input me-2" 
                                           type="checkbox" 
                                           id="approvalFilter"
                                           th:checked="${showApprovedOnly}"
                                           onchange="toggleApprovalFilter()">
                                    <label class="form-check-label fw-bold text-nowrap" 
                                           for="approvalFilter"
                                           style="font-size: 0.9rem;">
                                        승인된 밈만 보기
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-secondary w-100" id="clearFilters">
                                    🔄 초기화
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger w-100" id="deleteSelectedBtn" disabled>
                                    🗑️ 선택 삭제
                                </button>
                            </div>
                        </div>
                        
                        <!-- 일괄 삭제 폼 -->
                        <form id="deleteMultipleForm" th:action="@{/admin/memes/delete-multiple}" method="post" style="display: none;">
                            <input type="hidden" name="memeIds" id="selectedMemeIds">
                        </form>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th width="3%">
                                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox">
                                        </th>
                                        <th width="5%">ID</th>
                                        <th width="8%">이미지</th>
                                        <th width="12%">제목</th>
                                        <th width="12%">출처</th>
                                        <th width="17%">사용 맥락</th>
                                        <th width="12%">카테고리</th>
                                        <th width="10%">해시태그</th>
                                        <th width="8%">상태</th>
                                        <th width="12%">액션</th>
                                    </tr>
                                </thead>
                                <tbody id="memeTableBody">
                                    <tr th:if="${#lists.isEmpty(memes)}">
                                        <td colspan="10" class="text-center py-5 text-muted">
                                            <div class="emoji">😅</div>
                                            <p class="mb-0">아직 등록된 밈이 없습니다.</p>
                                        </td>
                                    </tr>
                                    
                                    <tr th:each="meme : ${memes}">
                                        <td class="align-middle">
                                            <input type="checkbox" 
                                                   class="form-check-input meme-checkbox" 
                                                   th:value="${meme.id}">
                                        </td>
                                        <td class="align-middle">
                                            <span class="badge bg-secondary" th:text="${meme.id}">1</span>
                                        </td>
                                        <td class="align-middle">
                                            <img th:if="${meme.imgUrl}" 
                                                 th:src="${meme.imgUrl}" 
                                                 th:alt="${meme.title}"
                                                 class="meme-image"
                                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0zMCAyMEMyNS4wMzc1IDIwIDIxIDI0LjAzNzUgMjEgMjlDMjEgMzMuOTYyNSAyNS4wMzc1IDM4IDMwIDM4QzM0Ljk2MjUgMzggMzkgMzMuOTYyNSAzOSAyOUMzOSAyNC4wMzc1IDM0Ljk2MjUgMjAgMzAgMjBaIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4K'">
                                            <div th:unless="${meme.imgUrl}" class="meme-image d-flex align-items-center justify-content-center bg-light">
                                                <span class="text-muted">🖼️</span>
                                            </div>
                                        </td>
                                        <td class="align-middle">
                                            <strong th:text="${meme.title}">밈 제목</strong>
                                        </td>
                                        <td class="align-middle">
                                            <div class="text-truncate-2" th:text="${meme.origin}">출처</div>
                                        </td>
                                        <td class="align-middle">
                                            <div class="text-truncate-2" th:text="${meme.usageContext}">사용 맥락</div>
                                        </td>
                                        <td class="align-middle">
                                            <div th:if="${memeCategoryMap[meme.id] != null and not #lists.isEmpty(memeCategoryMap[meme.id])}">
                                                <span th:each="categoryName, iterStat : ${memeCategoryMap[meme.id]}" 
                                                      class="badge bg-primary me-1 mb-1"
                                                      th:text="${categoryName}">카테고리</span>
                                            </div>
                                            <span th:unless="${memeCategoryMap[meme.id] != null and not #lists.isEmpty(memeCategoryMap[meme.id])}" 
                                                  class="text-muted small">미분류</span>
                                        </td>
                                        <td class="align-middle">
                                            <small class="text-muted" th:text="${meme.hashtags}">해시태그</small>
                                        </td>
                                        <td class="align-middle">
                                            <span th:if="${meme.flag != null and meme.flag.name() == 'NORMAL'}" 
                                                  class="badge bg-success">✅ 승인</span>
                                            <span th:if="${meme.flag != null and meme.flag.name() == 'ABNORMAL'}" 
                                                  class="badge bg-warning text-dark">⏳ 검토대기</span>
                                            <span th:unless="${meme.flag != null}" 
                                                  class="badge bg-secondary">미정</span>
                                        </td>
                                        <td class="align-middle">
                                            <div class="btn-group-vertical gap-1" role="group">
                                                <!-- 승인/반려 버튼 -->
                                                <div th:if="${meme.flag != null and meme.flag.name() == 'ABNORMAL'}" class="btn-group" role="group">
                                                    <button type="button" 
                                                            class="btn btn-success btn-sm"
                                                            th:onclick="|approveMeme(${meme.id})|"
                                                            title="승인 (정상으로 변경)">
                                                        ✅
                                                    </button>
                                                </div>
                                                <div th:if="${meme.flag != null and meme.flag.name() == 'NORMAL'}" class="btn-group" role="group">
                                                    <button type="button" 
                                                            class="btn btn-warning btn-sm"
                                                            th:onclick="|rejectMeme(${meme.id})|"
                                                            title="반려 (검토대기로 변경)">
                                                        ⚠️
                                                    </button>
                                                </div>
                                                
                                                <!-- 기존 수정/삭제 버튼 -->
                                                <div class="btn-group" role="group">
                                                    <a th:href="@{/admin/memes/{id}/edit(id=${meme.id})}" 
                                                       class="btn btn-primary btn-sm"
                                                       title="수정">
                                                        ✏️
                                                    </a>
                                                    <form th:action="@{/admin/memes/{id}/delete(id=${meme.id})}" 
                                                          method="post" 
                                                          style="display: inline;"
                                                          onsubmit="return confirm('정말로 이 밈을 삭제하시겠습니까?');">
                                                        <button type="submit" 
                                                                class="btn btn-danger btn-sm"
                                                                title="삭제">
                                                            🗑️
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 이미지 옵션 토글 함수
        function toggleImageOptions(changedElement) {
            const imageFileInput = document.getElementById('imageFile');
            const imgUrlInput = document.getElementById('imgUrl');
            
            if (changedElement.id === 'imageFile' && changedElement.files.length > 0) {
                // 파일이 선택되면 URL 입력 비활성화
                imgUrlInput.value = '';
                imgUrlInput.disabled = true;
                imgUrlInput.style.backgroundColor = '#f8f9fa';
            } else if (changedElement.id === 'imgUrl' && changedElement.value.trim() !== '') {
                // URL이 입력되면 파일 입력 비활성화
                imageFileInput.value = '';
                imageFileInput.disabled = true;
                imageFileInput.style.backgroundColor = '#f8f9fa';
            } else {
                // 값이 비어있으면 모든 옵션 활성화
                imageFileInput.disabled = false;
                imgUrlInput.disabled = false;
                imageFileInput.style.backgroundColor = '';
                imgUrlInput.style.backgroundColor = '';
            }
        }
        
        // 폼 제출 시 로딩 표시 및 validation
        document.getElementById('addMemeForm').addEventListener('submit', function(e) {
            const imageFileInput = document.getElementById('imageFile');
            const imgUrlInput = document.getElementById('imgUrl');
            
            // 이미지 업로드나 URL 중 하나는 반드시 있어야 함
            if (!imageFileInput.files.length && !imgUrlInput.value.trim()) {
                e.preventDefault();
                alert('이미지 파일을 업로드하거나 이미지 URL을 입력해주세요!');
                return false;
            }
            
            const button = this.querySelector('button[type="submit"]');
            const loading = button.querySelector('.loading');
            
            button.disabled = true;
            loading.style.display = 'inline-block';
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>업로드 중...';
        });
        
        // 파일 선택 시 미리보기 및 크기 체크
        document.getElementById('imageFile').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                // 파일 크기 체크 (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('파일 크기가 10MB를 초과합니다!');
                    this.value = '';
                    return;
                }
                console.log('✅ 파일 선택됨:', file.name, '(' + (file.size / 1024 / 1024).toFixed(2) + 'MB)');
            }
        });
        
        // 이미지 URL 입력 시 미리보기
        document.getElementById('imgUrl').addEventListener('input', function() {
            const url = this.value;
            if (url) {
                console.log('🔗 Image URL:', url);
            }
        });
        
        // 자동 알림 숨김
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
        
        // 필터링 기능
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const memeTableBody = document.getElementById('memeTableBody');
        const memeCount = document.getElementById('memeCount');
        
        let allRows = Array.from(memeTableBody.querySelectorAll('tr')).filter(row => 
            !row.querySelector('td[colspan]') // 빈 상태 메시지 행 제외
        );
        const totalCount = allRows.length;
        
        function filterMemes() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedCategory = categoryFilter.value.toLowerCase().trim();
            
            let visibleCount = 0;
            
            allRows.forEach(row => {
                const title = row.cells[2].textContent.toLowerCase();
                const origin = row.cells[3].textContent.toLowerCase();
                const usageContext = row.cells[4].textContent.toLowerCase();
                const hashtags = row.cells[6].textContent.toLowerCase();
                const categoryCell = row.cells[5];
                
                // 카테고리 정보 추출
                let rowCategories = [];
                const categoryBadges = categoryCell.querySelectorAll('.badge');
                if (categoryBadges.length > 0) {
                    categoryBadges.forEach(badge => {
                        rowCategories.push(badge.textContent.toLowerCase().trim());
                    });
                } else {
                    const uncategorizedSpan = categoryCell.querySelector('.text-muted');
                    if (uncategorizedSpan && uncategorizedSpan.textContent.includes('미분류')) {
                        rowCategories.push('미분류');
                    }
                }
                
                // 검색어 필터링
                const matchesSearch = !searchTerm || 
                    title.includes(searchTerm) || 
                    origin.includes(searchTerm) || 
                    usageContext.includes(searchTerm) || 
                    hashtags.includes(searchTerm);
                
                // 카테고리 필터링
                const matchesCategory = !selectedCategory || 
                    rowCategories.some(cat => cat === selectedCategory);
                
                if (matchesSearch && matchesCategory) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // 카운트 업데이트
            memeCount.textContent = `총 ${visibleCount}개`;
            
            // 결과가 없을 때 메시지 표시
            const emptyRow = memeTableBody.querySelector('tr[colspan]');
            if (visibleCount === 0 && totalCount > 0) {
                if (!document.getElementById('noResultsRow')) {
                    const noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'noResultsRow';
                    noResultsRow.innerHTML = `
                        <td colspan="10" class="text-center py-5 text-muted">
                            <div class="emoji">🔍</div>
                            <p class="mb-0">검색 결과가 없습니다.</p>
                        </td>
                    `;
                    memeTableBody.appendChild(noResultsRow);
                }
            } else {
                const noResultsRow = document.getElementById('noResultsRow');
                if (noResultsRow) {
                    noResultsRow.remove();
                }
            }
        }
        
        // 이벤트 리스너
        searchInput.addEventListener('input', filterMemes);
        categoryFilter.addEventListener('change', filterMemes);
        
        clearFiltersBtn.addEventListener('click', function() {
            searchInput.value = '';
            categoryFilter.value = '';
            
            // 승인 상태 체크박스도 초기화 (기본값인 승인된 밈만 보기로)
            const checkbox = document.getElementById('approvalFilter');
            checkbox.checked = true;
            
            const url = new URL(window.location);
            url.searchParams.set('showApprovedOnly', 'true');
            window.location.href = url.toString();
        });
        
        // 초기 로드 시 모든 행 표시
        filterMemes();
        
        // 성능 최적화된 체크박스 관리
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const deleteMultipleForm = document.getElementById('deleteMultipleForm');
        const selectedMemeIds = document.getElementById('selectedMemeIds');
        
        // Set 기반 선택된 밈 ID 관리
        const checkedMemeIds = new Set();
        
        // 디바운싱 함수
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 이벤트 위임: 테이블 전체에 단일 이벤트 리스너
        document.getElementById('memeTableBody').addEventListener('change', function(e) {
            if (e.target.matches('.meme-checkbox')) {
                const memeId = e.target.value;
                if (e.target.checked) {
                    checkedMemeIds.add(memeId);
                } else {
                    checkedMemeIds.delete(memeId);
                }
                debouncedUpdateDeleteButton();
            }
        });
        
        // 전체 선택 체크박스
        selectAllCheckbox.addEventListener('change', function() {
            const memeCheckboxes = document.querySelectorAll('.meme-checkbox');
            const visibleCheckboxes = Array.from(memeCheckboxes).filter(checkbox => 
                checkbox.closest('tr').style.display !== 'none'
            );
            
            checkedMemeIds.clear(); // 기존 선택 초기화
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                if (this.checked) {
                    checkedMemeIds.add(checkbox.value);
                }
            });
            
            updateDeleteButtonOptimized();
        });
        
        // 최적화된 선택 삭제 버튼 상태 업데이트
        function updateDeleteButtonOptimized() {
            // Set 기반으로 빠른 체크
            deleteSelectedBtn.disabled = checkedMemeIds.size === 0;
            
            // 전체 선택 체크박스 상태 업데이트 (필요시에만)
            const visibleCheckboxes = Array.from(document.querySelectorAll('.meme-checkbox')).filter(checkbox => 
                checkbox.closest('tr').style.display !== 'none'
            );
            
            // 보이는 체크박스들 중 선택된 것들의 개수
            let checkedVisibleCount = 0;
            visibleCheckboxes.forEach(checkbox => {
                if (checkedMemeIds.has(checkbox.value)) {
                    checkedVisibleCount++;
                }
            });
            
            if (checkedVisibleCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedVisibleCount === visibleCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        // 디바운싱된 업데이트 함수
        const debouncedUpdateDeleteButton = debounce(updateDeleteButtonOptimized, 50);
        
        // 전역 함수 (기존 HTML onchange와의 호환성)
        window.updateDeleteButton = debouncedUpdateDeleteButton;
        
        // 최적화된 선택 삭제 버튼 클릭
        deleteSelectedBtn.addEventListener('click', function() {
            const selectedIds = Array.from(checkedMemeIds);
            
            if (selectedIds.length === 0) {
                alert('삭제할 밈을 선택해주세요.');
                return;
            }
            
            if (!confirm(`선택한 ${selectedIds.length}개의 밈을 정말로 삭제하시겠습니까?`)) {
                return;
            }
            
            selectedMemeIds.value = selectedIds.join(',');
            deleteMultipleForm.submit();
        });
        
        // 필터링 후 체크박스 상태 업데이트
        const originalFilterMemes = filterMemes;
        filterMemes = function() {
            originalFilterMemes();
            updateDeleteButtonOptimized();
        };
        
        // 페이지 로드 시 초기 상태 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 기존에 체크된 체크박스들을 Set에 추가 (새로고침 등의 경우)
            document.querySelectorAll('.meme-checkbox:checked').forEach(checkbox => {
                checkedMemeIds.add(checkbox.value);
            });
            updateDeleteButtonOptimized();
        });
        
        // 밈 승인 함수
        function approveMeme(memeId) {
            if (!confirm('이 밈을 승인하시겠습니까? 승인하면 전체 사용자에게 공개됩니다.')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '처리중...';
            
            fetch(`/admin/memes/${memeId}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                if (data.includes('승인되었습니다')) {
                    location.reload();
                } else {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ 처리 중 오류가 발생했습니다.');
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // 밈 반려 함수
        function rejectMeme(memeId) {
            if (!confirm('이 밈을 검토대기 상태로 되돌리시겠습니까?')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '처리중...';
            
            fetch(`/admin/memes/${memeId}/reject`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                if (data.includes('반려되었습니다')) {
                    location.reload();
                } else {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ 처리 중 오류가 발생했습니다.');
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        // 승인 상태 토글 함수
        function toggleApprovalFilter() {
            const checkbox = document.getElementById('approvalFilter');
            const isChecked = checkbox.checked;
            const url = new URL(window.location);
            
            // 명시적으로 true/false 값을 설정
            url.searchParams.set('showApprovedOnly', isChecked ? 'true' : 'false');
            
            // 페이지 새로고침으로 필터 적용
            window.location.href = url.toString();
        }
    </script>
</body>
</html>
